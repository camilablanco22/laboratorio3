{% extends "base/base.html" %}
{% load static%}
{% block titulo %}Registrar venta{% endblock %}
{% block contenido_principal %}
    <div class="container-fluid text-center rounded cabecera mt-5">
        <header id="home">
            <h1>Ventas</h1>
            <h2>Registrar</h2>
        </header>
    </div>


    <div class="container-fluid mt-3 mb-3">

        <form method="post">
            {% csrf_token %}

            <!-- FORMULARIO DE LA VENTA-->
            <fieldset class="rounded border formulario">
                <h4>Información de la venta</h4>
                <div class="row g-3">
                    {% for field in form %}
                        <div class="campo">
                            {{ field.errors }}
                            {{ field.label_tag }} {{ field }}
                        </div><br>
                    {% endfor %}
                    {% csrf_token %} <!--cuestion de token de seguridad-->
                </div>

            </fieldset>

            <fieldset class="rounded border formulario">
                <h4>Item</h4>
                {{ formset.management_form }}
                <div id="formset-container">

                    {% for form in formset %}
                    <div class="item-form mb-3 p-3 border rounded">
                        {{ form.as_p }}
                        <p></p>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-secondary" id="add-form" >Agregar Item</button><!--onclick="addInput()-->

            </fieldset>


            <div class="mt-3">
                <button type="submit" class="btn btn-primary">REGISTRAR</button>
            </div>


        </form>
    </div>

{% endblock %}

{% block javascript %}
<script>
    //FORMA DEL CODIGO DE LA PROFE CECILIA
    document.addEventListener('DOMContentLoaded', function() {
        const addButton = document.getElementById('add-form');
        const formsetContainer = document.getElementById('formset-container');
        const totalForms = document.getElementById('id_items_venta-TOTAL_FORMS');

        // Función para actualizar los índices de los formularios
        function updateFormIndexes() {
            const forms = formsetContainer.getElementsByClassName('item-form');
            for (let i = 0; i < forms.length; i++) {
                const formInputs = forms[i].getElementsByTagName('input');
                const formSelects = forms[i].getElementsByTagName('select');

                for (let input of formInputs) {
                    updateElementIndex(input, 'items', i);
                }
                for (let select of formSelects) {
                    updateElementIndex(select, 'items', i);
                }
            }
            totalForms.value = forms.length;
        }

        // Función para actualizar el índice de un elemento
        function updateElementIndex(element, prefix, index) {
            const idRegex = new RegExp(`(${prefix}-\\d+)`);
            const replacement = `${prefix}-${index}`;
            if (element.id) element.id = element.id.replace(idRegex, replacement);
            if (element.name) element.name = element.name.replace(idRegex, replacement);
        }

        // Agregar nuevo formulario
        addButton.addEventListener('click', function(e) {
            e.preventDefault();
            const formCount = formsetContainer.children.length;
            const template = formsetContainer.children[0].cloneNode(true);

            // Limpiar los valores del formulario clonado
            template.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
            template.querySelectorAll('select').forEach(select => select.selectedIndex = 0);

            formsetContainer.appendChild(template);
            updateFormIndexes();
        });

        // Eliminar formulario
        formsetContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-form')) {
                e.preventDefault();
                const form = e.target.closest('.seccion-form');
                form.remove();
                updateFormIndexes();
            }
        });
    });













    /*FORMA DEL VIDEO DE YOUTUBE
    function addInput(){
        var forms = document.querySelector('#id_items_venta-TOTAL_FORMS');

        //Actualización de for para label producto
        newLabelProducto = document.querySelector('label[for="id_items_venta-0-producto"]').cloneNode(true);;
        newLabelProducto.htmlFor = 'id_items_venta-'+forms.value+'-producto'

        //Actualización de id y name para input producto
        var newProducto = document.querySelector('#id_items_venta-0-producto').cloneNode(true);
        newProducto.name = 'items_venta-'+forms.value+'-producto'
        newProducto.id = 'id_items_venta-'+forms.value+'-producto'

        //Actualización de for para label cantidad
        newLabelCantidad = document.querySelector('label[for="id_items_venta-0-cantidad"]').cloneNode(true);;
        newLabelCantidad.htmlFor = 'id_items_venta-'+forms.value+'-cantidad'

        //Actualización de id y name para input cantidad
        var newCantidad = document.querySelector('#id_items_venta-0-cantidad').cloneNode(true);
        newCantidad.name = 'items_venta-'+forms.value+'-cantidad'
        newCantidad.id = 'id_items_venta-'+forms.value+'-cantidad'

        var p1 = document.createElement("p");
        var p2 = document.createElement("p");

        document.querySelector('#formset-container').appendChild(newLabelProducto)
        document.querySelector('#formset-container').appendChild(newProducto)
        document.querySelector('#formset-container').appendChild(p1)

        document.querySelector('#formset-container').appendChild(newLabelCantidad)
        document.querySelector('#formset-container').appendChild(newCantidad)
        document.querySelector('#formset-container').appendChild(p2)

        forms.value = parseInt(forms.value) + 1
    }
    */
</script>
{% endblock %}